FROM php:7.1.3-apache

# Update and Download Packages Debian
RUN echo 'deb http://httpredir.debian.org/debian jessie contrib' >> /etc/apt/sources.list \
  && apt-get --force-yes update && apt-get --force-yes upgrade -y --no-install-recommends apt-utils

# Install Dependencies
RUN apt-get --yes --force-yes install \
 autoconf \
 vim \
 nano \
 bzip2 \
 curl \
 ca-certificates \
 gettext \
 git \
 make \
 libbz2-dev \
 libcurl4-openssl-dev \
 libicu-dev \
 libzip-dev \
 librabbitmq-dev \
 libgd-dev \
 libjpeg62-turbo-dev \
 libpq-dev\
 libpng-dev \
 libssl-dev\
 libtidy-dev \
 libxslt-dev \
 libxml2-dev \
 openssl \
 pkg-config \
 subversion \
 tar \
 unzip \
 zlib1g-dev \
 zip \
 wget \
 libonig-dev -y


RUN wget -qO- https://deb.nodesource.com/setup_9.x -o nodesource_setup.sh
RUN bash nodesource_setup.sh
RUN apt-get update -y
RUN apt-get --force-yes --yes install -y nodejs
RUN rm nodesource_setup.sh
RUN mkdir /.config
RUN mkdir /.npm
RUN chown -R $USER_ID:$USER_ID /.config
RUN chown -R $USER_ID:$USER_ID /.npm
RUN touch /.npmrc
RUN chown -R $USER_ID:$USER_ID /.npmrc
ENV NPM_CONFIG_USERCONFIG=/.npmrc


RUN chown -R www-data:www-data /var/www/html

ADD https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/

RUN chmod +x /usr/local/bin/install-php-extensions && install-php-extensions gd xdebug

RUN docker-php-ext-configure gd --with-freetype=/usr/include/

# Install Extensions
RUN docker-php-ext-install bcmath
RUN docker-php-ext-install bz2
RUN docker-php-ext-install calendar
RUN docker-php-ext-install exif
RUN docker-php-ext-install gd
RUN docker-php-ext-install gettext
RUN docker-php-ext-install intl
RUN docker-php-ext-install mbstring
RUN docker-php-ext-install pdo
RUN docker-php-ext-install pdo_mysql
RUN docker-php-ext-install soap
RUN docker-php-ext-install tidy
RUN docker-php-ext-install xsl
RUN docker-php-ext-install zip

RUN docker-php-ext-configure hash --with-mhash
RUN docker-php-ext-configure intl
RUN docker-php-ext-configure zip

# Install Composer
ENV COMPOSER_ALLOW_SUPERUSER=1
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# RUN apt-get --yes --force-yes install systemctl -y

RUN chmod 777 -R /var/www/html/

RUN echo "date.timezone=America/Sao_Paulo" > $PHP_INI_DIR/conf.d/date_timezone.ini
#COPY www.conf /usr/local/etc/php-fpm.d/www.conf
RUN rm /etc/apache2/apache2.conf
RUN rm /etc/apache2/sites-enabled/000-default.conf
COPY apache2.conf /etc/apache2/apache2.conf
RUN a2enmod rewrite
RUN a2enmod vhost_alias
COPY 000-default.conf /etc/apache2/sites-enabled/000-default.conf
RUN find /var/www/html -type d -exec chmod 755 {} \;
RUN service apache2 restart
# RUN a2ensite 000-default.conf
# RUN a2dissite limbotecnologia.com.br.conf
# RUN systemctl reload apache2
# RUN systemctl reload apache2

RUN  mkdir /var/run/redis



# CMD [ "node", "storage/bot/app.js"]

RUN pwd

# Clean
RUN apt-get clean -y
RUN rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /usr/share/doc/*

EXPOSE 80
